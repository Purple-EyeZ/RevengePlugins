(function(exports,plugin,metro,common,patcher,assets,toasts,utils,_vendetta,ui,storage){"use strict";var LazyActionSheet=metro.findByProps("openLazy","hideActionSheet"),ActionSheetRow=metro.findByProps("ActionSheetRow")?.ActionSheetRow,DownloadIcon=assets.getAssetIDByName("DownloadIcon"),JSON_CODEBLOCK_PATTERN=/^```(?:json)\n([\s\S]*?)```$/gm;function patchMessageLongPressActionSheet(){return patcher.before("openLazy",LazyActionSheet,([component,key,msg])=>{if(key==="MessageLongPressActionSheet"){var content=msg?.message?.content;content&&component.then(instance=>{var unpatch=patcher.after("default",instance,(_,res)=>{common.React.useEffect(()=>()=>{unpatch()},[]);var rules=[...content.matchAll(JSON_CODEBLOCK_PATTERN)].map(m=>{try{return JSON.parse(m[1])}catch{return null}}).filter(r=>r&&typeof r.name=="string"&&typeof r.match=="string"&&typeof r.replace=="string");if(rules.length){var buttons=utils.findInReactTree(res,x=>Array.isArray(x)&&x.some(c=>c?.type?.name==="ActionSheetRow"));buttons&&rules.forEach(rule=>{buttons.unshift(common.React.createElement(ActionSheetRow,{label:`Import Rule: ${rule.name}`,icon:common.React.createElement(ActionSheetRow.Icon,{source:DownloadIcon}),onPress:()=>{LazyActionSheet.hideActionSheet(),plugin.storage.rules=[...plugin.storage.rules,rule],toasts.showToast(`Imported ${rule.name}`,DownloadIcon)}}))})}})})}})}var Messages=metro.findByProps("sendMessage","receiveMessage"),Warning=assets.getAssetIDByName("ic_warning_24px");function patchSendMessage(){return patcher.before("sendMessage",Messages,args=>{var rules=plugin.storage.rules.filter(rule2=>rule2.match),content=args[1].content;for(var rule of rules)if(rule.regex)try{var pattern=new RegExp(rule.match,rule.flags);content=content.replace(pattern,rule.replace)}catch(e){_vendetta.logger.error(e),toasts.showToast(`Failed to use RegExp for ${rule.name}!`,Warning)}else content=content.replaceAll(rule.match,rule.replace);args[1].content=content})}var ThemeStore=metro.findByStoreName("ThemeStore"),colorModule=metro.findByProps("colors","unsafe_rawColors"),colorResolver=colorModule?.internal??colorModule?.meta,resolveSemanticColor=(color,theme=ThemeStore.theme)=>color&&colorResolver?.resolveSemanticColor(theme,color)||"#000000",findRedesignComponent=propName=>metro.findByProps(propName)?.[propName],TextStyleSheet=metro.findByProps("TextStyleSheet")?.TextStyleSheet;function Text({variant,color,align,style,lineClamp,children,...props}){var computedStyle=[];return variant&&TextStyleSheet?.[variant]&&computedStyle.push(TextStyleSheet[variant]),color&&ui.semanticColors[color]&&computedStyle.push({color:resolveSemanticColor(ui.semanticColors[color])}),align&&computedStyle.push({textAlign:align}),style&&computedStyle.push(style),React.createElement(common.ReactNative.Text,{style:computedStyle,numberOfLines:lineClamp,...props},children)}var{ScrollView:ScrollView$1,View:View$1,Keyboard}=common.ReactNative,{TableRow:TableRow$1,TableRowGroup:TableRowGroup$1,Stack:Stack$1,TableSwitchRow}=common.components,TextInput=findRedesignComponent("TextInput"),{openAlert,dismissAlert}=metro.findByProps("openAlert","dismissAlert"),{AlertModal,AlertActions,AlertActionButton}=metro.findByProps("AlertModal","AlertActions"),InputRow=({label,value,onChange,placeholder,isClearable})=>common.React.createElement(TableRow$1,{label,subLabel:common.React.createElement(View$1,{style:{marginTop:8}},common.React.createElement(TextInput,{placeholder,value,onChange,isClearable}))});function EditRule({ruleIndex}){var initialRule=plugin.storage.rules[ruleIndex];if(!initialRule)return null;var[localRule,setLocalRule]=common.React.useState(initialRule),navigation=common.NavigationNative.useNavigation(),ruleRef=common.React.useRef(localRule),isDeletingRef=common.React.useRef(!1),[keyboardHeight,setKeyboardHeight]=common.React.useState(0);common.React.useEffect(()=>{var showSub=Keyboard.addListener("keyboardDidShow",e=>{setKeyboardHeight(e.endCoordinates.height)}),hideSub=Keyboard.addListener("keyboardDidHide",()=>{setKeyboardHeight(0)});return()=>{showSub.remove(),hideSub.remove()}},[]),common.React.useEffect(()=>{var unsubscribe=navigation.addListener("beforeRemove",()=>{if(!(isDeletingRef.current||!plugin.storage.rules[ruleIndex])){var newRules=[...plugin.storage.rules];newRules[ruleIndex]=ruleRef.current,plugin.storage.rules=newRules}});return unsubscribe},[navigation,ruleIndex]);var updateRule=(key,value)=>{setLocalRule(prev=>{var newState={...prev,[key]:value};return ruleRef.current=newState,newState})},deleteRule=()=>{isDeletingRef.current=!0;var newRules=[...plugin.storage.rules];newRules.splice(ruleIndex,1),plugin.storage.rules=newRules,navigation.goBack()},handleDeletePress=()=>{openAlert("delete-rule-confirmation",common.React.createElement(AlertModal,{title:"Delete Rule?",content:"Are you sure you want to delete this rule? This action cannot be undone.",extraContent:common.React.createElement(View$1,{style:{backgroundColor:resolveSemanticColor(ui.semanticColors.BACKGROUND_SECONDARY),padding:12,borderRadius:12}},common.React.createElement(Text,{variant:"text-md/bold",align:"center",color:"TEXT_DEFAULT"},localRule.name||"Unnamed Rule")),actions:common.React.createElement(AlertActions,null,common.React.createElement(AlertActionButton,{text:"Cancel",variant:"secondary",onPress:()=>dismissAlert("delete-rule-confirmation")}),common.React.createElement(AlertActionButton,{text:"Delete",variant:"destructive",onPress:()=>{dismissAlert("delete-rule-confirmation"),deleteRule()}}))}))},copyRule=()=>{var ruleJson=JSON.stringify(localRule,null,4);common.clipboard.setString(`\`\`\`json
${ruleJson}
\`\`\``),toasts.showToast(`Rule ${localRule.name} copied to clipboard`,assets.getAssetIDByName("CopyIcon"))};return common.React.createElement(ScrollView$1,{style:{flex:1},contentContainerStyle:{paddingBottom:keyboardHeight+12},keyboardShouldPersistTaps:"handled"},common.React.createElement(Stack$1,{style:{paddingVertical:24,paddingHorizontal:16},spacing:24},common.React.createElement(TableRowGroup$1,{title:"Configuration"},common.React.createElement(InputRow,{label:"Name",value:localRule.name,onChange:v=>updateRule("name",v),placeholder:"Rule Name",isClearable:!0}),common.React.createElement(InputRow,{label:"Match",value:localRule.match,onChange:v=>updateRule("match",v),placeholder:"Text to replace"}),common.React.createElement(InputRow,{label:"Replace with",value:localRule.replace,onChange:v=>updateRule("replace",v),placeholder:"New text"})),common.React.createElement(TableRowGroup$1,{title:"Settings"},common.React.createElement(TableSwitchRow,{label:"Regex Mode",subLabel:"Treat the match string as a Regular Expression",value:localRule.regex,onValueChange:v=>updateRule("regex",v)}),localRule.regex&&common.React.createElement(InputRow,{label:"Regex Flags",value:localRule.flags,onChange:v=>updateRule("flags",v),placeholder:"gi"})),common.React.createElement(TableRowGroup$1,{title:"Actions"},common.React.createElement(TableRow$1,{label:"Copy Rule JSON",icon:common.React.createElement(TableRow$1.Icon,{source:assets.getAssetIDByName("CopyIcon")}),onPress:copyRule,arrow:!0}),common.React.createElement(TableRow$1,{label:"Delete Rule",icon:common.React.createElement(TableRow$1.Icon,{source:assets.getAssetIDByName("TrashIcon"),variant:"danger"}),onPress:handleDeletePress,variant:"danger",arrow:!0}))))}var{ScrollView,View}=common.ReactNative,{TableRow,Stack,TableRowGroup}=common.components,Button=findRedesignComponent("Button");function Settings(){storage.useProxy(plugin.storage);var navigation=common.NavigationNative.useNavigation(),createNewRule=()=>{var newRule={name:"New Rule",match:"",flags:"gi",replace:"",regex:!1};plugin.storage.rules=[...plugin.storage.rules,newRule],navigation.push("VendettaCustomPage",{title:"Edit Rule",render:()=>React.createElement(EditRule,{ruleIndex:plugin.storage.rules.length-1})})};return React.createElement(View,{style:{flex:1}},React.createElement(ScrollView,{contentContainerStyle:{paddingBottom:80}},React.createElement(Stack,{style:{paddingVertical:24,paddingHorizontal:16},spacing:24},React.createElement(TableRowGroup,{title:"Rules"},plugin.storage.rules.length===0?React.createElement(View,{style:{padding:16,alignItems:"center"}},React.createElement(Text,{align:"center",variant:"text-md/medium",color:"TEXT_MUTED"},"No rules created yet.")):plugin.storage.rules.map((rule,index2)=>React.createElement(TableRow,{key:index2,label:rule.name?`${rule.name}`:"Unnamed Rule",subLabel:rule.match?`Matches: ${rule.match}`:"No match pattern set",onPress:()=>navigation.push("VendettaCustomPage",{title:"Edit Rule",render:()=>React.createElement(EditRule,{ruleIndex:index2})}),arrow:!0}))),React.createElement(Button,{text:"New Rule",variant:"primary",size:"md",onPress:createNewRule,icon:assets.getAssetIDByName("PlusSmallIcon"),iconPosition:"start"}))))}var patches=[],index={onLoad:()=>{var _a;(_a=plugin.storage).rules??(_a.rules=[]),patches.push(patchSendMessage()),patches.push(patchMessageLongPressActionSheet())},onUnload:()=>{for(var unpatch of patches)unpatch();patches=[]},settings:Settings};return exports.default=index,Object.defineProperty(exports,"__esModule",{value:!0}),exports})({},vendetta.plugin,bunny.metro,bunny.metro.common,vendetta.patcher,vendetta.ui.assets,vendetta.ui.toasts,vendetta.utils,vendetta,vendetta.ui,vendetta.storage);
